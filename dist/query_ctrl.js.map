{"version":3,"sources":["../src/query_ctrl.js"],"names":["QueryCtrl","TIME_INDEX","INTERVAL_TYPE_WINDOW","INTERVAL_TYPE_FIXED","ScalyrDatasourceQueryCtrl","$scope","$injector","$window","$httpParamSerializer","scope","target","filter","secondsInterval","graphFunctions","intervalTypes","supportedIntervalTypes","graphFunction","expression","n","intervalType","chosenType","queryTypes","type","percentage","placeholder","panel","targets","length","window","serializer","datasource","queryControls","push","panelName","title","showQueryParts","parseComplex","query","metricFindQuery","rawQuery","setTarget","panelCtrl","refresh","hide","response","data","find","element","refId","queryParts","queries","function","replace","timeFrame","getTargetTimeframe","queryParams","severity","Object","assign","qs","url","open","now","Date","startTime","getTime","endTime","dataSet","datapoints","slice","defaultData","templateUrl"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAQA,qB,kBAAAA,S;;;;;;;;;;;;;;;;;;;;;;;;;;;AAEFC,sB,GAAa,C;AACbC,gC,GAAuB,Q;AACvBC,+B,GAAsB,O;;iDAEfC,yB;;;AAET,mDAAYC,MAAZ,EAAoBC,SAApB,EAA+BC,OAA/B,EAAwCC,oBAAxC,EAA8D;AAAA;;AAAA,sKACpDH,MADoD,EAC5CC,SAD4C;;AAE1D,0BAAKG,KAAL,GAAaJ,MAAb;AACA,0BAAKK,MAAL,CAAYC,MAAZ,GAAqB,MAAKD,MAAL,CAAYC,MAAZ,IAAsB,EAA3C;AACA,0BAAKD,MAAL,CAAYE,eAAZ,GAA8B,MAAKF,MAAL,CAAYE,eAAZ,IAA+B,EAA7D;AACA;AACA,0BAAKC,cAAL,GAAsB,CAClB,MADkB,EACV,KADU,EACH,KADG,EACI,cADJ,EACoB,QADpB,EAC8B,KAD9B,EACqC,KADrC,EAC4C,KAD5C,EACmD,KADnD,EAC0D,MAD1D,EACkE,MADlE,EAC0E,UAD1E,EACsF,MADtF,EAC8F,OAD9F,CAAtB;AAGA,0BAAKC,aAAL,GAAqB,CACjBZ,oBADiB,EACKC,mBADL,CAArB;AAGA,0BAAKY,sBAAL,GAA8B,CAC1B,QAD0B,EAChB,MADgB,EACR,KADQ,EACD,MADC,CAA9B;AAGA,0BAAKL,MAAL,CAAYM,aAAZ,GAA4B,MAAKN,MAAL,CAAYM,aAAZ,IAA6B,MAAKH,cAAL,CAAoB,CAApB,CAAzD;AACA,0BAAKH,MAAL,CAAYO,UAAZ,GAAyB,MAAKP,MAAL,CAAYO,UAAZ,IAA0B,EAAnD;AACA,0BAAKP,MAAL,CAAYQ,CAAZ,GAAgB,MAAKR,MAAL,CAAYQ,CAAZ,IAAiB,EAAjC;AACA,0BAAKR,MAAL,CAAYS,YAAZ,GAA2B,MAAKT,MAAL,CAAYS,YAAZ,IAA4B,MAAKL,aAAL,CAAmB,CAAnB,CAAvD;AACA,0BAAKJ,MAAL,CAAYU,UAAZ,GAAyB,MAAKV,MAAL,CAAYU,UAAZ,IAA0B,MAAKL,sBAAL,CAA4B,CAA5B,CAAnD;AACA,0BAAKM,UAAL,GAAkB,CACd,eADc,EAEd,aAFc,EAGd,uBAHc,CAAlB;AAKA,0BAAKX,MAAL,CAAYY,IAAZ,GAAmB,MAAKZ,MAAL,CAAYY,IAAZ,IAAoB,MAAKD,UAAL,CAAgB,CAAhB,CAAvC;AACA,0BAAKX,MAAL,CAAYa,UAAZ,GAAyB,MAAKb,MAAL,CAAYa,UAAZ,IAA0B,EAAnD;AACA,0BAAKb,MAAL,CAAYc,WAAZ,GAA0B,YAAY,MAAKC,KAAL,CAAWC,OAAX,CAAmBC,MAAzD;AACA,0BAAKC,MAAL,GAAcrB,OAAd;AACA,0BAAKsB,UAAL,GAAkBrB,oBAAlB;;AAEA,0BAAKsB,UAAL,CAAgBC,aAAhB,CAA8BC,IAA9B;AACA,0BAAKF,UAAL,CAAgBG,SAAhB,GAA4B,MAAKR,KAAL,CAAWS,KAAvC;AACA,0BAAKxB,MAAL,CAAYyB,cAAZ,GAA6B,MAAKL,UAAL,CAAgBM,YAA7C;AAjC0D;AAkC7D;;;;+CAEUC,K,EAAO;AACd,+BAAO,KAAKP,UAAL,CAAgBQ,eAAhB,CAAgCD,SAAS,EAAzC,CAAP;AACH;;;uDAEkB;AACf,6BAAK3B,MAAL,CAAY6B,QAAZ,GAAuB,CAAC,KAAK7B,MAAL,CAAY6B,QAApC;AACH;;;uDAEkB;AACf,6BAAKC,SAAL;AACA,gCAAQ,KAAK9B,MAAL,CAAYY,IAApB;AACI,iCAAK,eAAL;AACI,oCAAI,KAAKZ,MAAL,CAAYS,YAAZ,KAA6BhB,mBAA7B,IACI,KAAKO,MAAL,CAAYS,YAAZ,KAA6BjB,oBAA7B,IAAqD,KAAKQ,MAAL,CAAYE,eAAZ,GAA8B,CAD3F,EAEA;AACI,yCAAK6B,SAAL,CAAeC,OAAf,GADJ,CAC8B;AAC7B;AACD;AACJ,iCAAK,aAAL;AACI,qCAAKD,SAAL,CAAeC,OAAf,GADJ,CAC8B;AAC1B;AACJ,iCAAK,uBAAL;AACI,oCAAI,KAAKhC,MAAL,CAAYS,YAAZ,KAA6BhB,mBAA7B,IACI,KAAKO,MAAL,CAAYS,YAAZ,KAA6BjB,oBAA7B,IAAqD,KAAKQ,MAAL,CAAYE,eAAZ,GAA8B,CAD3F,EAC+F;AAC3F,yCAAK6B,SAAL,CAAeC,OAAf,GAD2F,CACjE;AAC7B;AACD;AACJ;AAjBJ;AAoBH;;;sDAEiB;AAAA;;AACd,4BAAG,KAAKhC,MAAL,CAAYiC,IAAZ,KAAqB,IAArB,IAA6B,KAAKjC,MAAL,CAAYY,IAAZ,KAAqB,uBAAlD,IAA6E,CAAC,KAAKZ,MAAL,CAAYyB,cAA1F,IAA4G,CAAC,KAAKL,UAAL,CAAgBM,YAAhI,EAA8I;AAC1I;AACH;;AAED,4BAAG,KAAKN,UAAL,CAAgBc,QAAhB,CAAyBC,IAA5B,EAAkC;AAC9B,gCAAIA,OAAO,KAAKf,UAAL,CAAgBc,QAAhB,CAAyBC,IAAzB,CAA8BC,IAA9B,CAAmC,UAACC,OAAD,EAAa;AACvD,uCAAOA,QAAQC,KAAR,KAAkB,OAAKtC,MAAL,CAAYsC,KAArC;AACH,6BAFU,CAAX;;AAIA,iCAAKC,UAAL,GAAkB,EAAlB;AAL8B;AAAA;AAAA;;AAAA;AAM9B,qDAAkBJ,KAAKK,OAAvB,8HAAgC;AAAA,wCAAvBb,KAAuB;;AAC5B,wCAAG,QAAOA,KAAP,yCAAOA,KAAP,OAAiB,QAApB,EAA8B;AAC1B,6CAAKY,UAAL,CAAgBjB,IAAhB,CAAqBK,MAAMc,QAAN,GAAiB,GAAjB,GAAuBd,MAAM1B,MAA7B,GAAsC,GAA3D;AACH,qCAFD,MAEO;AACH,6CAAKsC,UAAL,CAAgBjB,IAAhB,CAAqBK,KAArB;AACH;AACJ;AAZ6B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAajC;AACJ;;;gDAEW;AACR,4BAAI,KAAK3B,MAAL,CAAYA,MAAZ,KAAuB,EAAvB,IAA6B,KAAKA,MAAL,CAAYY,IAAzC,IAAiD,KAAKZ,MAAL,CAAYM,aAAjE,EAAgF;AAC5E,iCAAKN,MAAL,CAAYc,WAAZ,GAA0B,gBAAgB,CAAC,KAAKd,MAAL,CAAYY,IAAZ,GAAmB,GAAnB,GAAyB,KAAKZ,MAAL,CAAYM,aAAtC,EAAqDoC,OAArD,CAA6D,MAA7D,EAAqE,GAArE,CAA1C;AACH;AACJ;;;qDAKgB;AACb,4BAAI,KAAK1C,MAAL,CAAYC,MAAZ,KAAuB,EAA3B,EAA+B;AAC3B;AACA;;;;AAIA,gCAAIA,SAAS,KAAKD,MAAL,CAAYC,MAAzB;AACAA,qCAASA,OAAOyC,OAAP,CAAe,KAAf,EAAsB,GAAtB,CAAT;AACAzC,qCAASA,OAAOyC,OAAP,CAAe,MAAf,EAAuB,IAAvB,CAAT;;AAEA,gCAAIC,YAAY,KAAKC,kBAAL,CAAwB,KAAK5C,MAAL,CAAYA,MAApC,CAAhB;;AAEA,gCAAI6C,cAAc;AACdC,0CAAU,CADI;AAEd7C,wCAAQA;AAFM,6BAAlB;;AAKA4C,0CAAcE,OAAOC,MAAP,CAAcH,WAAd,EAA2BF,SAA3B,CAAd;;AAEA,gCAAIM,KAAK,KAAK9B,UAAL,CAAgB0B,WAAhB,CAAT;AACA,gCAAIK,MAAM,mCAAmCD,EAA7C;AACA,iCAAK/B,MAAL,CAAYiC,IAAZ,CAAiBD,GAAjB,EAAsB,QAAtB;AACH;AACJ;;;uDAUkBlD,M,EAAQ;AACvB,4BAAI,KAAKoB,UAAL,CAAgBc,QAAhB,CAAyBC,IAAzB,CAA8BlB,MAA9B,KAAyC,CAA7C,EAAgD;AAC5C;AACA,gCAAImC,MAAM,IAAIC,IAAJ,EAAV;AACA,mCAAO;AACHC,2CAAWF,IAAIG,OAAJ,KAAiB,OAAO,EAAP,GAAY,EAAZ,GAAiB,EAD1C;AAEHC,yCAASJ,IAAIG,OAAJ;AAFN,6BAAP;AAIH;AARsB;AAAA;AAAA;;AAAA;AASvB,kDAAoB,KAAKnC,UAAL,CAAgBc,QAAhB,CAAyBC,IAA7C,mIAAmD;AAAA,oCAA1CsB,OAA0C;;AAC/C,oCAAIA,QAAQzD,MAAR,KAAmBA,MAAvB,EAA+B;AAC3B,2CAAO;AACHsD,mDAAWG,QAAQC,UAAR,CAAmB,CAAnB,EAAsBnE,UAAtB,CADR;AAEHiE,iDAASC,QAAQC,UAAR,CAAmBC,KAAnB,CAAyB,CAAC,CAA1B,EAA6B,CAA7B,EAAgCpE,UAAhC;AAFN,qCAAP;AAIH;AACJ;AACD;AAjBuB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAkBvB,4BAAIqE,cAAc,KAAKxC,UAAL,CAAgBc,QAAhB,CAAyBC,IAAzB,CAA8B,CAA9B,CAAlB;AACA,+BAAO;AACHmB,uCAAWM,YAAYF,UAAZ,CAAuB,CAAvB,EAA0BnE,UAA1B,CADR;AAEHiE,qCAASI,YAAYF,UAAZ,CAAuBC,KAAvB,CAA6B,CAAC,CAA9B,EAAiC,CAAjC,EAAoCpE,UAApC;AAFN,yBAAP;AAIH;;;;cA7J0CD,S;;;;AAgK/CI,sCAA0BmE,WAA1B,GAAwC,4BAAxC","file":"query_ctrl.js","sourcesContent":["import {QueryCtrl} from 'app/plugins/sdk';\n\nconst TIME_INDEX = 1;\nconst INTERVAL_TYPE_WINDOW = 'window';\nconst INTERVAL_TYPE_FIXED = 'fixed';\n\nexport class ScalyrDatasourceQueryCtrl extends QueryCtrl {\n\n    constructor($scope, $injector, $window, $httpParamSerializer) {\n        super($scope, $injector);\n        this.scope = $scope;\n        this.target.filter = this.target.filter || \"\";\n        this.target.secondsInterval = this.target.secondsInterval || 60;\n        // this.target.interval = this.target.interval || 60;\n        this.graphFunctions = [\n            'mean', 'min', 'max', 'sumPerSecond', 'median', 'p10', 'p50', 'p95', 'p99', 'p999', 'p(n)', 'fraction', 'rate', 'count'\n        ];\n        this.intervalTypes = [\n            INTERVAL_TYPE_WINDOW, INTERVAL_TYPE_FIXED\n        ];\n        this.supportedIntervalTypes = [\n            'minute', 'hour', 'day', 'week'\n        ];\n        this.target.graphFunction = this.target.graphFunction || this.graphFunctions[0];\n        this.target.expression = this.target.expression || '';\n        this.target.n = this.target.n || 66;\n        this.target.intervalType = this.target.intervalType || this.intervalTypes[0];\n        this.target.chosenType = this.target.chosenType || this.supportedIntervalTypes[0];\n        this.queryTypes = [\n            'numeric query',\n            'facet query',\n            'complex numeric query'\n        ];\n        this.target.type = this.target.type || this.queryTypes[0];\n        this.target.percentage = this.target.percentage || 25;\n        this.target.placeholder = \"target \" + this.panel.targets.length;\n        this.window = $window;\n        this.serializer = $httpParamSerializer;\n\n        this.datasource.queryControls.push(this);\n        this.datasource.panelName = this.panel.title;\n        this.target.showQueryParts = this.datasource.parseComplex;\n    }\n\n    getOptions(query) {\n        return this.datasource.metricFindQuery(query || '');\n    }\n\n    toggleEditorMode() {\n        this.target.rawQuery = !this.target.rawQuery;\n    }\n\n    onChangeInternal() {\n        this.setTarget();\n        switch (this.target.type) {\n            case 'numeric query':\n                if (this.target.intervalType === INTERVAL_TYPE_FIXED\n                    || (this.target.intervalType === INTERVAL_TYPE_WINDOW && this.target.secondsInterval > 0))\n                {\n                    this.panelCtrl.refresh(); // Asks the panel to refresh data.\n                }\n                break;\n            case 'facet query':\n                this.panelCtrl.refresh(); // Asks the panel to refresh data.\n                break;\n            case 'complex numeric query':\n                if (this.target.intervalType === INTERVAL_TYPE_FIXED\n                    || (this.target.intervalType === INTERVAL_TYPE_WINDOW && this.target.secondsInterval > 0)) {\n                    this.panelCtrl.refresh(); // Asks the panel to refresh data.\n                }\n                break;\n            default:\n        }\n\n    }\n\n    getComplexParts() {\n        if(this.target.hide === true || this.target.type !== 'complex numeric query' || !this.target.showQueryParts || !this.datasource.parseComplex) {\n            return;\n        }\n\n        if(this.datasource.response.data) {\n            let data = this.datasource.response.data.find((element) => {\n                return element.refId === this.target.refId\n            });\n\n            this.queryParts = [];\n            for (let query of data.queries) {\n                if(typeof query === \"object\") {\n                    this.queryParts.push(query.function + \"(\" + query.filter + \")\");\n                } else {\n                    this.queryParts.push(query);\n                }\n            }\n        }\n    }\n\n    setTarget() {\n        if (this.target.target === '' && this.target.type && this.target.graphFunction) {\n            this.target.placeholder = \"target for \" + (this.target.type + \" \" + this.target.graphFunction).replace(\"/ /g\", \"_\");\n        }\n    }\n\n    /**\n     * Opens the Scalyr logs page in a new window\n     */\n    openScalyrLogs() {\n        if (this.target.filter !== '') {\n            //convert filter to the scalyr logs page\n            /**\n             * Example\n             * https://www.scalyr.com/events?barWidth=30%20minutes&severity=0&filter=$serverHost%3D%27app001%27&startTime=1519121858224&endTime=1519136228224\n             */\n            let filter = this.target.filter;\n            filter = filter.replace(\" = \", \"=\");\n            filter = filter.replace(\" == \", \"==\");\n\n            let timeFrame = this.getTargetTimeframe(this.target.target);\n\n            let queryParams = {\n                severity: 0,\n                filter: filter\n            };\n\n            queryParams = Object.assign(queryParams, timeFrame);\n\n            let qs = this.serializer(queryParams);\n            let url = 'https://www.scalyr.com/events?' + qs;\n            this.window.open(url, '_blank');\n        }\n    }\n\n    /**\n     * Gets the first and last time values of the target data points that were returned to grafana.\n     *\n     * The return values should be unix_timestamp values in milliseconds\n     *\n     * @param target string The name of the target that is required\n     * @returns {{startTime: int, endTime: int}}\n     */\n    getTargetTimeframe(target) {\n        if (this.datasource.response.data.length === 0) {\n            //return a default 24 hours if a response doesn't have data\n            let now = new Date();\n            return {\n                startTime: now.getTime() - (1000 * 60 * 60 * 24),\n                endTime: now.getTime()\n            }\n        }\n        for (let dataSet of this.datasource.response.data) {\n            if (dataSet.target === target) {\n                return {\n                    startTime: dataSet.datapoints[0][TIME_INDEX],\n                    endTime: dataSet.datapoints.slice(-1)[0][TIME_INDEX]\n                }\n            }\n        }\n        //default to returning the from and to values of the first panel/dashboard\n        let defaultData = this.datasource.response.data[0];\n        return {\n            startTime: defaultData.datapoints[0][TIME_INDEX],\n            endTime: defaultData.datapoints.slice(-1)[0][TIME_INDEX]\n        };\n    }\n}\n\nScalyrDatasourceQueryCtrl.templateUrl = 'partials/query.editor.html';\n\n"]}
{"version":3,"sources":["../src/query_ctrl.js"],"names":["QueryCtrl","TIME_INDEX","INTERVAL_TYPE_WINDOW","INTERVAL_TYPE_FIXED","GenericDatasourceQueryCtrl","$scope","$injector","$window","$httpParamSerializer","scope","target","filter","secondsInterval","graphFunctions","intervalTypes","supportedIntervalTypes","graphFunction","intervalType","chosenType","queryTypes","type","percentage","placeholder","panel","targets","length","window","serializer","datasource","queryControls","push","query","metricFindQuery","rawQuery","setTarget","panelCtrl","refresh","showQueryParts","response","data","find","element","refId","queryParts","queries","function","replace","timeFrame","getTargetTimeframe","queryParams","severity","Object","assign","qs","url","open","dataList","dataSet","startTime","datapoints","endTime","slice","templateUrl"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAQA,qB,kBAAAA,S;;;;;;;;;;;;;;;;;;;;;AAGFC,sB,GAAa,C;AACbC,gC,GAAuB,Q;AACvBC,+B,GAAsB,O;;kDAEfC,0B;;;AAIT,oDAAYC,MAAZ,EAAoBC,SAApB,EAA+BC,OAA/B,EAAwCC,oBAAxC,EAA8D;AAAA;;AAAA,wKACpDH,MADoD,EAC5CC,SAD4C;;AAG1D,0BAAKG,KAAL,GAAaJ,MAAb;;AAGA,0BAAKK,MAAL,CAAYC,MAAZ,GAAqB,MAAKD,MAAL,CAAYC,MAAZ,IAAsB,EAA3C;AACA,0BAAKD,MAAL,CAAYE,eAAZ,GAA8B,MAAKF,MAAL,CAAYE,eAAZ,IAA+B,EAA7D;AACA;AACA,0BAAKC,cAAL,GAAsB,CAClB,MADkB,EACV,KADU,EACH,KADG,EACI,cADJ,EACoB,QADpB,EAC8B,KAD9B,EACqC,KADrC,EAC4C,IAD5C,EACkD,IADlD,EACwD,KADxD,EAC+D,MAD/D,EACuE,UADvE,EACmF,EADnF,EACuF,MADvF,EAC+F,OAD/F,CAAtB;AAGA,0BAAKC,aAAL,GAAqB,CACjBZ,oBADiB,EACKC,mBADL,CAArB;AAGA,0BAAKY,sBAAL,GAA8B,CAC1B,QAD0B,EAChB,MADgB,EACR,KADQ,EACD,MADC,EACO,OADP,CAA9B;AAGA,0BAAKL,MAAL,CAAYM,aAAZ,GAA4B,MAAKN,MAAL,CAAYM,aAAZ,IAA6B,MAAKH,cAAL,CAAoB,CAApB,CAAzD;AACA,0BAAKH,MAAL,CAAYO,YAAZ,GAA2B,MAAKP,MAAL,CAAYO,YAAZ,IAA4B,MAAKH,aAAL,CAAmB,CAAnB,CAAvD;AACA,0BAAKJ,MAAL,CAAYQ,UAAZ,GAAyB,MAAKR,MAAL,CAAYQ,UAAZ,IAA0B,MAAKH,sBAAL,CAA4B,CAA5B,CAAnD;AACA,0BAAKI,UAAL,GAAkB,CACd,eADc,EAEd,aAFc,EAGd,uBAHc,CAAlB;AAKA,0BAAKT,MAAL,CAAYU,IAAZ,GAAmB,MAAKV,MAAL,CAAYU,IAAZ,IAAoB,MAAKD,UAAL,CAAgB,CAAhB,CAAvC;AACA,0BAAKT,MAAL,CAAYW,UAAZ,GAAyB,MAAKX,MAAL,CAAYW,UAAZ,IAA0B,EAAnD;AACA,0BAAKX,MAAL,CAAYY,WAAZ,GAA0B,YAAY,MAAKC,KAAL,CAAWC,OAAX,CAAmBC,MAAzD;AACA,0BAAKC,MAAL,GAAcnB,OAAd;AACA,0BAAKoB,UAAL,GAAkBnB,oBAAlB;;AAEA,0BAAKoB,UAAL,CAAgBC,aAAhB,CAA8BC,IAA9B;AAhC0D;AAiC7D;;;;+CAEUC,K,EAAO;AACd,+BAAO,KAAKH,UAAL,CAAgBI,eAAhB,CAAgCD,SAAS,EAAzC,CAAP;AACH;;;uDAEkB;AACf,6BAAKrB,MAAL,CAAYuB,QAAZ,GAAuB,CAAC,KAAKvB,MAAL,CAAYuB,QAApC;AACH;;;uDAEkB;AACf,6BAAKC,SAAL;AACA,gCAAQ,KAAKxB,MAAL,CAAYU,IAApB;AACI,iCAAK,eAAL;AACI,oCAAI,KAAKV,MAAL,CAAYO,YAAZ,KAA6Bd,mBAA7B,IACI,KAAKO,MAAL,CAAYO,YAAZ,KAA6Bf,oBAA7B,IAAqD,KAAKQ,MAAL,CAAYE,eAAZ,GAA8B,CAD3F,EAEA;AACI,yCAAKuB,SAAL,CAAeC,OAAf,GADJ,CAC8B;AAC7B;AACD;AACJ,iCAAK,aAAL;AACI,qCAAKD,SAAL,CAAeC,OAAf,GADJ,CAC8B;AAC1B;AACJ,iCAAK,uBAAL;AACI,oCAAI,KAAK1B,MAAL,CAAYO,YAAZ,KAA6Bd,mBAA7B,IACI,KAAKO,MAAL,CAAYO,YAAZ,KAA6Bf,oBAA7B,IAAqD,KAAKQ,MAAL,CAAYE,eAAZ,GAA8B,CAD3F,EAC+F;AAC3F,yCAAKuB,SAAL,CAAeC,OAAf,GAD2F,CACjE;AAC7B;AACD;AACJ;AAjBJ;AAoBH;;;sDAEiB;AAAA;;AACd,4BAAG,KAAK1B,MAAL,CAAYU,IAAZ,KAAqB,uBAArB,IAAgD,CAAC,KAAKV,MAAL,CAAY2B,cAAhE,EAAgF;AAC5E;AACH;;AAED,4BAAG,KAAKT,UAAL,CAAgBU,QAAhB,CAAyBC,IAA5B,EAAkC;AAC9B,gCAAIA,OAAO,KAAKX,UAAL,CAAgBU,QAAhB,CAAyBC,IAAzB,CAA8BC,IAA9B,CAAmC,UAACC,OAAD,EAAa;AACvD,uCAAOA,QAAQC,KAAR,KAAkB,OAAKhC,MAAL,CAAYgC,KAArC;AACH,6BAFU,CAAX;;AAIA,iCAAKC,UAAL,GAAkB,EAAlB;AAL8B;AAAA;AAAA;;AAAA;AAM9B,qDAAkBJ,KAAKK,OAAvB,8HAAgC;AAAA,wCAAvBb,KAAuB;;AAC5B,yCAAKY,UAAL,CAAgBb,IAAhB,CAAqBC,MAAMc,QAAN,GAAiB,GAAjB,GAAuBd,MAAMpB,MAA7B,GAAsC,GAA3D;AACH;AAR6B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AASjC;AACJ;;;gDAEW;AACR,4BAAI,KAAKD,MAAL,CAAYA,MAAZ,KAAuB,EAAvB,IAA6B,KAAKA,MAAL,CAAYU,IAAzC,IAAiD,KAAKV,MAAL,CAAYM,aAAjE,EAAgF;AAC5E,iCAAKN,MAAL,CAAYY,WAAZ,GAA0B,gBAAgB,CAAC,KAAKZ,MAAL,CAAYU,IAAZ,GAAmB,GAAnB,GAAyB,KAAKV,MAAL,CAAYM,aAAtC,EAAqD8B,OAArD,CAA6D,MAA7D,EAAqE,GAArE,CAA1C;AACH;AACJ;;;qDAKgB;AACb,4BAAI,KAAKpC,MAAL,CAAYC,MAAZ,KAAuB,EAA3B,EAA+B;AAC3B;AACA;;;;AAIA,gCAAIA,SAAS,KAAKD,MAAL,CAAYC,MAAzB;AACAA,qCAASA,OAAOmC,OAAP,CAAe,KAAf,EAAsB,GAAtB,CAAT;AACAnC,qCAASA,OAAOmC,OAAP,CAAe,MAAf,EAAuB,IAAvB,CAAT;;AAEA,gCAAIC,YAAY,KAAKC,kBAAL,CAAwB,KAAKtC,MAAL,CAAYA,MAApC,CAAhB;;AAEA,gCAAIuC,cAAc;AACdC,0CAAU,CADI;AAEdvC,wCAAQA;AAFM,6BAAlB;;AAKAsC,0CAAcE,OAAOC,MAAP,CAAcH,WAAd,EAA2BF,SAA3B,CAAd;;AAGA,gCAAIM,KAAK,KAAK1B,UAAL,CAAgBsB,WAAhB,CAAT;AACA,gCAAIK,MAAM,mCAAmCD,EAA7C;AACA,iCAAK3B,MAAL,CAAY6B,IAAZ,CAAiBD,GAAjB,EAAsB,QAAtB;AACH;AACJ;;;uDAUkB5C,M,EAAQ;AAAA;AAAA;AAAA;;AAAA;AACvB,kDAAoB,KAAKyB,SAAL,CAAeqB,QAAnC,mIAA6C;AAAA,oCAApCC,OAAoC;;AACzC,oCAAIA,QAAQ/C,MAAR,KAAmBA,MAAvB,EAA+B;AAC3B,2CAAO;AACHgD,mDAAWD,QAAQE,UAAR,CAAmB,CAAnB,EAAsB1D,UAAtB,CADR;AAEH2D,iDAASH,QAAQE,UAAR,CAAmBE,KAAnB,CAAyB,CAAC,CAA1B,EAA6B,CAA7B,EAAgC5D,UAAhC;AAFN,qCAAP;AAIH;AACJ;AARsB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAS1B;;;;cA7I2CD,S;;;;AAgJhDI,uCAA2B0D,WAA3B,GAAyC,4BAAzC","file":"query_ctrl.js","sourcesContent":["import {QueryCtrl} from 'app/plugins/sdk';\r\nimport './css/query-editor.css!'\r\n\r\nconst TIME_INDEX = 1;\r\nconst INTERVAL_TYPE_WINDOW = 'window';\r\nconst INTERVAL_TYPE_FIXED = 'fixed';\r\n\r\nexport class GenericDatasourceQueryCtrl extends QueryCtrl {\r\n\r\n\r\n\r\n    constructor($scope, $injector, $window, $httpParamSerializer) {\r\n        super($scope, $injector);\r\n\r\n        this.scope = $scope;\r\n\r\n\r\n        this.target.filter = this.target.filter || \"\";\r\n        this.target.secondsInterval = this.target.secondsInterval || 60;\r\n        // this.target.interval = this.target.interval || 60;\r\n        this.graphFunctions = [\r\n            'mean', 'min', 'max', 'sumPerSecond', 'median', 'p10', 'p50', '95', '99', '999', 'p(n)', 'fraction', '', 'rate', 'count'\r\n        ];\r\n        this.intervalTypes = [\r\n            INTERVAL_TYPE_WINDOW, INTERVAL_TYPE_FIXED\r\n        ];\r\n        this.supportedIntervalTypes = [\r\n            'minute', 'hour', 'day', 'week', 'month'\r\n        ];\r\n        this.target.graphFunction = this.target.graphFunction || this.graphFunctions[0];\r\n        this.target.intervalType = this.target.intervalType || this.intervalTypes[0];\r\n        this.target.chosenType = this.target.chosenType || this.supportedIntervalTypes[0];\r\n        this.queryTypes = [\r\n            'numeric query',\r\n            'facet query',\r\n            'complex numeric query'\r\n        ];\r\n        this.target.type = this.target.type || this.queryTypes[0];\r\n        this.target.percentage = this.target.percentage || 25;\r\n        this.target.placeholder = \"target \" + this.panel.targets.length;\r\n        this.window = $window;\r\n        this.serializer = $httpParamSerializer\r\n\r\n        this.datasource.queryControls.push(this);\r\n    }\r\n\r\n    getOptions(query) {\r\n        return this.datasource.metricFindQuery(query || '');\r\n    }\r\n\r\n    toggleEditorMode() {\r\n        this.target.rawQuery = !this.target.rawQuery;\r\n    }\r\n\r\n    onChangeInternal() {\r\n        this.setTarget();\r\n        switch (this.target.type) {\r\n            case 'numeric query':\r\n                if (this.target.intervalType === INTERVAL_TYPE_FIXED\r\n                    || (this.target.intervalType === INTERVAL_TYPE_WINDOW && this.target.secondsInterval > 0))\r\n                {\r\n                    this.panelCtrl.refresh(); // Asks the panel to refresh data.\r\n                }\r\n                break;\r\n            case 'facet query':\r\n                this.panelCtrl.refresh(); // Asks the panel to refresh data.\r\n                break;\r\n            case 'complex numeric query':\r\n                if (this.target.intervalType === INTERVAL_TYPE_FIXED\r\n                    || (this.target.intervalType === INTERVAL_TYPE_WINDOW && this.target.secondsInterval > 0)) {\r\n                    this.panelCtrl.refresh(); // Asks the panel to refresh data.\r\n                }\r\n                break;\r\n            default:\r\n        }\r\n\r\n    }\r\n\r\n    getComplexParts() {\r\n        if(this.target.type !== 'complex numeric query' || !this.target.showQueryParts) {\r\n            return;\r\n        }\r\n\r\n        if(this.datasource.response.data) {\r\n            let data = this.datasource.response.data.find((element) => {\r\n                return element.refId === this.target.refId\r\n            });\r\n\r\n            this.queryParts = [];\r\n            for (let query of data.queries) {\r\n                this.queryParts.push(query.function + \"(\" + query.filter + \")\");\r\n            }\r\n        }\r\n    }\r\n\r\n    setTarget() {\r\n        if (this.target.target === '' && this.target.type && this.target.graphFunction) {\r\n            this.target.placeholder = \"target for \" + (this.target.type + \" \" + this.target.graphFunction).replace(\"/ /g\", \"_\");\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Opens the Scalyr logs page in a new window\r\n     */\r\n    openScalyrLogs() {\r\n        if (this.target.filter !== '') {\r\n            //convert filter to the scalyr logs page\r\n            /**\r\n             * Example\r\n             * https://www.scalyr.com/events?barWidth=30%20minutes&severity=0&filter=$serverHost%3D%27app001%27&startTime=1519121858224&endTime=1519136228224\r\n             */\r\n            let filter = this.target.filter;\r\n            filter = filter.replace(\" = \", \"=\");\r\n            filter = filter.replace(\" == \", \"==\");\r\n\r\n            let timeFrame = this.getTargetTimeframe(this.target.target);\r\n\r\n            let queryParams = {\r\n                severity: 0,\r\n                filter: filter\r\n            };\r\n\r\n            queryParams = Object.assign(queryParams, timeFrame);\r\n\r\n\r\n            let qs = this.serializer(queryParams);\r\n            let url = 'https://www.scalyr.com/events?' + qs;\r\n            this.window.open(url, '_blank');\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Gets the first and last time values of the target data points that were returned to grafana.\r\n     *\r\n     * The return values should be unix_timestamp values in milliseconds\r\n     *\r\n     * @param target string The name of the target that is required\r\n     * @returns {{startTime: int, endTime: int}}\r\n     */\r\n    getTargetTimeframe(target) {\r\n        for (let dataSet of this.panelCtrl.dataList) {\r\n            if (dataSet.target === target) {\r\n                return {\r\n                    startTime: dataSet.datapoints[0][TIME_INDEX],\r\n                    endTime: dataSet.datapoints.slice(-1)[0][TIME_INDEX]\r\n                }\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\nGenericDatasourceQueryCtrl.templateUrl = 'partials/query.editor.html';\r\n\r\n"]}
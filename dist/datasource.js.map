{"version":3,"sources":["../src/datasource.js"],"names":["_","GenericDatasource","instanceSettings","$q","backendSrv","templateSrv","type","url","name","q","withCredentials","headers","basicAuth","length","parseComplex","jsonData","parseQueries","queryControls","options","query","targets","filter","t","hide","when","data","user","contextSrv","userId","id","org","orgName","orgId","panelName","doRequest","method","then","res","response","queryControl","getComplexParts","status","message","title","replace","annotation","annotationQuery","range","datasource","enable","iconColor","rangeRaw","result","interpolated","target","mapToTextValue","map","d","i","text","value","isObject","datasourceRequest","scopedVars","refId"],"mappings":"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","file":"datasource.js","sourcesContent":["import _ from \"lodash\";\n\nexport class GenericDatasource {\n\n    constructor(instanceSettings, $q, backendSrv, templateSrv) {\n        this.type = instanceSettings.type;\n        this.url = instanceSettings.url;\n        this.name = instanceSettings.name;\n        this.q = $q;\n        this.backendSrv = backendSrv;\n        this.templateSrv = templateSrv;\n        this.withCredentials = instanceSettings.withCredentials;\n        this.headers = {'Content-Type': 'application/json'};\n        if (typeof instanceSettings.basicAuth === 'string' && instanceSettings.basicAuth.length > 0) {\n            this.headers['Authorization'] = instanceSettings.basicAuth;\n        }\n\n        this.parseComplex = instanceSettings.jsonData.parseQueries;\n\n        this.queryControls = [];\n    }\n\n    query(options) {\n        // var query = this.buildQueryParameters(options);\n        var query = options;\n        query.targets = query.targets.filter(t => !t.hide);\n\n        if (query.targets.length <= 0) {\n            return this.q.when({data: []});\n        }\n\n        query.parseComplex = this.parseComplex;\n\n        query.user = this.backendSrv.contextSrv.user.name;\n        query.userId = this.backendSrv.contextSrv.user.id;\n        query.org = this.backendSrv.contextSrv.user.orgName;\n        query.orgId = this.backendSrv.contextSrv.user.orgId;\n        //Set in query ctrl constructor\n        query.panelName = this.panelName;\n\n        return this.doRequest({\n            url: this.url + '/query',\n            data: query,\n            method: 'POST'\n        }).then((res) => {\n            //Holds on to the response so that it's accessible by the query controls\n            this.response = res;\n            for(let queryControl of this.queryControls) {\n                queryControl.getComplexParts();\n            }\n            return res;\n        } );\n    }\n\n    testDatasource() {\n        return this.doRequest({\n            url: this.url + '/',\n            method: 'GET',\n        }).then(response => {\n            if (response.status === 200) {\n                return {status: \"success\", message: \"Data source is working\", title: \"Success\"};\n            }\n        });\n    }\n\n    annotationQuery(options) {\n        var query = this.templateSrv.replace(options.annotation.query, {}, 'glob');\n        var annotationQuery = {\n            range: options.range,\n            annotation: {\n                name: options.annotation.name,\n                datasource: options.annotation.datasource,\n                enable: options.annotation.enable,\n                iconColor: options.annotation.iconColor,\n                query: query\n            },\n            rangeRaw: options.rangeRaw\n        };\n\n        return this.doRequest({\n            url: this.url + '/annotations',\n            method: 'POST',\n            data: annotationQuery\n        }).then(result => {\n            return result.data;\n        });\n    }\n\n    metricFindQuery(query) {\n        var interpolated = {\n            target: this.templateSrv.replace(query, null, 'regex')\n        };\n\n        return this.doRequest({\n            url: this.url + '/search',\n            data: interpolated,\n            method: 'POST',\n        }).then(this.mapToTextValue);\n    }\n\n    mapToTextValue(result) {\n        return _.map(result.data, (d, i) => {\n            if (d && d.text && d.value) {\n                return {text: d.text, value: d.value};\n            } else if (_.isObject(d)) {\n                return {text: d, value: i};\n            }\n            return {text: d, value: d};\n        });\n    }\n\n    doRequest(options) {\n        options.withCredentials = this.withCredentials;\n        options.headers = this.headers;\n\n        this.options = options;\n\n        return this.backendSrv.datasourceRequest(options);\n    }\n\n    buildQueryParameters(options) {\n        //remove placeholder targets\n        options.targets = _.filter(options.targets, target => {\n            return target.target !== 'select metric';\n        });\n\n        var targets = _.map(options.targets, target => {\n            return {\n                target: this.templateSrv.replace(target.target, options.scopedVars, 'regex'),\n                refId: target.refId,\n                hide: target.hide,\n                type: target.type || 'timeserie'\n            };\n        });\n\n        options.targets = targets;\n\n        return options;\n    }\n}\n"]}
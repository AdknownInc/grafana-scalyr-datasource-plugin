{"version":3,"sources":["../src/datasource.js"],"names":["_","GenericDatasource","instanceSettings","$q","backendSrv","templateSrv","type","url","name","q","templateVarIdentifier","templateVarEscaperChar","modifyTemplateVariableIdentifier","addTemplateVariableEscapeChar","withCredentials","headers","basicAuth","length","parseComplex","jsonData","parseQueries","queryControls","String","prototype","reverse","split","join","filter","replace","RegExp","newFilter","a","b","variable","index","Object","hasOwnProperty","current","value","options","targets","t","hide","when","data","query","JSON","parse","stringify","i","reverseAllVariables","findAndReverse","removeEscapeChar","user","contextSrv","userId","id","org","orgName","orgId","panelName","doRequest","method","then","res","response","queryControl","getComplexParts","status","message","title","annotation","annotationQuery","range","datasource","enable","iconColor","rangeRaw","result","interpolated","target","mapToTextValue","map","d","text","isObject","datasourceRequest","scopedVars","refId","newIdentifier","regStr","regex","source","escape","identifier"],"mappings":"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","file":"datasource.js","sourcesContent":["import _ from \"lodash\";\r\n\r\nexport class GenericDatasource {\r\n\r\n    constructor(instanceSettings, $q, backendSrv, templateSrv) {\r\n        this.type = instanceSettings.type;\r\n        this.url = instanceSettings.url;\r\n        this.name = instanceSettings.name;\r\n        this.q = $q;\r\n        this.backendSrv = backendSrv;\r\n        this.templateVarIdentifier = '~';\r\n        this.templateVarEscaperChar = \"\\\\\";\r\n        this.templateSrv = GenericDatasource.modifyTemplateVariableIdentifier(templateSrv, this.templateVarIdentifier);\r\n        this.templateSrv = GenericDatasource.addTemplateVariableEscapeChar(this.templateSrv, this.templateVarEscaperChar, this.templateVarIdentifier);\r\n        this.withCredentials = instanceSettings.withCredentials;\r\n        this.headers = {'Content-Type': 'application/json'};\r\n        if (typeof instanceSettings.basicAuth === 'string' && instanceSettings.basicAuth.length > 0) {\r\n            this.headers['Authorization'] = instanceSettings.basicAuth;\r\n        }\r\n\r\n        this.parseComplex = instanceSettings.jsonData.parseQueries;\r\n\r\n        this.queryControls = [];\r\n\r\n        //Used for escaping template variables, needed to write regex backwards to take advantage of lookbehinds\r\n        String.prototype.reverse = function () {\r\n            return this.split('').reverse().join('');\r\n        };\r\n    }\r\n\r\n    static modifyTemplateVariableIdentifier(templateSrv, newIdentifier) {\r\n        let regStr = templateSrv.regex.source;\r\n\r\n        //There are 2 occurrences of '\\$'. Remember to escape!\r\n        regStr = regStr.replace(/\\\\\\$/g, newIdentifier);\r\n        templateSrv.regex = new RegExp(regStr, 'g');\r\n        return templateSrv;\r\n    }\r\n\r\n    static addTemplateVariableEscapeChar(templateSrv, escape, identifier) {\r\n        let regStr = templateSrv.regex.source;\r\n\r\n        //We have to write our regex backwards because lookbehinds aren't supported everywhere yet.\r\n        regStr = regStr.replace(RegExp(identifier + \"\\\\(\\\\\\\\w\\\\+\\\\)\", 'g'), `(\\\\w+)${identifier}(?=[^${\"\\\\\" + escape}]|$)`);\r\n        templateSrv.regex = new RegExp(regStr, 'g');\r\n        return templateSrv;\r\n    }\r\n\r\n    removeEscapeChar(filter) {\r\n        return filter.replace(RegExp(\"\\\\\" + this.templateVarEscaperChar + this.templateVarIdentifier,'g'), this.templateVarIdentifier);\r\n    }\r\n\r\n    findAndReverse(filter) {\r\n        let newFilter = filter.reverse();\r\n        return newFilter.replace(RegExp(`(\\\\w+)(?=${this.templateVarIdentifier}(?!\\\\${this.templateVarEscaperChar}))`,'g'), function (a,b){\r\n            return b.reverse();\r\n        });\r\n    }\r\n\r\n    reverseAllVariables() {\r\n        for (let variable in this.templateSrv.index) {\r\n            // noinspection JSUnfilteredForInLoop\r\n            if (this.templateSrv.index[variable] instanceof Object\r\n                && this.templateSrv.index[variable].hasOwnProperty(\"current\")) {\r\n                // noinspection JSUnfilteredForInLoop\r\n                this.templateSrv.index[variable].current.value = this.templateSrv.index[variable].current.value.reverse();\r\n            }\r\n        }\r\n    }\r\n\r\n    query(options) {\r\n        options.targets = options.targets.filter(t => !t.hide);\r\n\r\n        if (options.targets.length <= 0) {\r\n            return this.q.when({data: []});\r\n        }\r\n        //Deep copy the object. When template variables are swapped out we don't want to modify the original values\r\n        let query = JSON.parse(JSON.stringify(options));\r\n\r\n        for(let i = 0; i < query.targets.length; i++) {\r\n            this.reverseAllVariables();\r\n            let filter = this.findAndReverse(query.targets[i].filter);\r\n            query.targets[i].filter = this.findAndReverse(this.templateSrv.replace(filter, null, 'regex'));\r\n            query.targets[i].filter = this.removeEscapeChar(query.targets[i].filter);\r\n            this.reverseAllVariables();\r\n        }\r\n\r\n        query.parseComplex = this.parseComplex;\r\n\r\n        query.user = this.backendSrv.contextSrv.user.name;\r\n        query.userId = this.backendSrv.contextSrv.user.id;\r\n        query.org = this.backendSrv.contextSrv.user.orgName;\r\n        query.orgId = this.backendSrv.contextSrv.user.orgId;\r\n        //Set in query ctrl constructor\r\n        query.panelName = this.panelName;\r\n\r\n        return this.doRequest({\r\n            url: this.url + '/query',\r\n            data: query,\r\n            method: 'POST'\r\n        }).then((res) => {\r\n            //Holds on to the response so that it's accessible by the query controls\r\n            this.response = res;\r\n            for(let queryControl of this.queryControls) {\r\n                queryControl.getComplexParts();\r\n            }\r\n            return res;\r\n        } );\r\n    }\r\n\r\n    testDatasource() {\r\n        return this.doRequest({\r\n            url: this.url + '/',\r\n            method: 'GET',\r\n        }).then(response => {\r\n            if (response.status === 200) {\r\n                return {status: \"success\", message: \"Data source is working\", title: \"Success\"};\r\n            }\r\n        });\r\n    }\r\n\r\n    annotationQuery(options) {\r\n        var query = this.templateSrv.replace(options.annotation.query, {}, 'glob');\r\n        var annotationQuery = {\r\n            range: options.range,\r\n            annotation: {\r\n                name: options.annotation.name,\r\n                datasource: options.annotation.datasource,\r\n                enable: options.annotation.enable,\r\n                iconColor: options.annotation.iconColor,\r\n                query: query\r\n            },\r\n            rangeRaw: options.rangeRaw\r\n        };\r\n\r\n        return this.doRequest({\r\n            url: this.url + '/annotations',\r\n            method: 'POST',\r\n            data: annotationQuery\r\n        }).then(result => {\r\n            return result.data;\r\n        });\r\n    }\r\n\r\n    metricFindQuery(query) {\r\n        var interpolated = {\r\n            target: this.templateSrv.replace(query, null, 'regex')\r\n        };\r\n\r\n        return this.doRequest({\r\n            url: this.url + '/search',\r\n            data: interpolated,\r\n            method: 'POST',\r\n        }).then(this.mapToTextValue);\r\n    }\r\n\r\n    mapToTextValue(result) {\r\n        return _.map(result.data, (d, i) => {\r\n            if (d && d.text && d.value) {\r\n                return {text: d.text, value: d.value};\r\n            } else if (_.isObject(d)) {\r\n                return {text: d, value: i};\r\n            }\r\n            return {text: d, value: d};\r\n        });\r\n    }\r\n\r\n    doRequest(options) {\r\n        options.withCredentials = this.withCredentials;\r\n        options.headers = this.headers;\r\n\r\n        this.options = options;\r\n\r\n        return this.backendSrv.datasourceRequest(options);\r\n    }\r\n\r\n    buildQueryParameters(options) {\r\n        //remove placeholder targets\r\n        options.targets = _.filter(options.targets, target => {\r\n            return target.target !== 'select metric';\r\n        });\r\n\r\n        var targets = _.map(options.targets, target => {\r\n            return {\r\n                target: this.templateSrv.replace(target.target, options.scopedVars, 'regex'),\r\n                refId: target.refId,\r\n                hide: target.hide,\r\n                type: target.type || 'timeserie'\r\n            };\r\n        });\r\n\r\n        options.targets = targets;\r\n\r\n        return options;\r\n    }\r\n}\r\n"]}